<!DOCTYPE html>
<html>
  <head>
  	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="assets/jquery.min.js"></script>
    <script src="assets/bower_components/moment/moment.js"></script>
    <script src="http://malsup.github.com/jquery.form.js"></script> 
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,300,300italic,400italic,500italic' rel='stylesheet' type='text/css'>
  </head>
  <style type="text/css">
  body {font-family: 'Roboto', sans-serif;}

  .user,
  #matches > div,
  #pool,
  #details > a,
  #new {
  	display:block;
  	float:left;
  	margin:10px;
  	padding:10px;
  	background: #CAE2E0;
  	color:#102B0F;
  	box-shadow: 3px 3px 10px #888;
  }
  #matches,#users {clear:both;}
  #matches > div {
  	background: #F3F1BD;
  }
  #pool {
    background: #F36148;
  }
  .user,
  #matches > div {cursor:pointer;}

  .user.uno {
      background: #B90203;
      color: white;
  }
  .user.uno::after { 
    content: " - Bestia";
  }
  .user.due {
      background: #80E785;
  }
  .user.due::after { 
    content: " - Vinta 1";
  }
  .user.tre {
      background: #52C860;
  }
  .user.tre::after { 
    content: " - Vinte 2";
  }
  .user.quattro {
      background: #1E9A26;
  }
  .user.quattro::after { 
    content: " - Vinte 3";
  }

  #details {display: none;}

  #details > a {
    text-decoration: none;
    background:#FFC609;
  }
  </style>
  <script type="text/javascript">

  	

  	$(document).ready(function(){
  		var users = $("#users");
  		var matches = $("#matches");
      var details = $("#details");
  		function loadUsers(){
	  		users.html("");
	  		$.getJSON("/api/users",function(response){
	  			response.forEach(function(u){
	  				users.append(NewUser(u,false));
	  			});
	  		});
	  	}

      function NewUser(u,showAmount){
        text = u.Name;
        if (showAmount && u.Amount!=undefined) {
          text += " <strong>"+u.Amount+"</strong>";
        }
        return $("<div>").addClass("user").data("clicks",0).html(text).data("user_id",u.ID);
      }

	  	function loadMatches(){
	  		matches.html("");
	  		$.getJSON("/api/matches",function(response){
	  			response.forEach(function(m){
	  				d = moment(m.CreatedAt)
	  				var nm = $("<div>").text(d.calendar()+" ("+m.Players.length+")").data("match_id",m.ID);
	  				matches.append(nm);
	  			});
	  		});
	  	}

      function matchDetails(match){
        players = details.find("#players");
        players.html("");
        match.Players.forEach(function(u){
            players.append(NewUser(u,true));
        });
        details.find("#pool > strong").text(match.Pool);
        details.show();
      }

  		loadUsers();
  		loadMatches();

  		$('#new-user').ajaxForm({
		    success: function() { 
		        loadUsers();
		        $('#name').val("");
		    },
		    error: function(data) { 
		    	alert("Error: "+data.responseText); 
		    }
  		}); 

  		users.on("dblclick","div",function(){
  			if(!confirm("Are you sure you want to delete it?")) {return;}
  			var user_id = $(this).data("user_id");
  			$.ajax({
  				url:"/api/users/"+user_id,
  				method:"DELETE",
  				success:function(){
	  				loadUsers();
	  			}
  			});
  		});

      matches.on("click","div",function(){
        var match_id = $(this).data("match_id");
        $.getJSON("/api/matches/"+match_id,function(data){
            matchDetails(data);  
        });
      });

  		matches.on("dblclick","div",function(){
  			if(!confirm("Are you sure you want to delete it?")) {return;}
  			var match_id = $(this).data("match_id");
  			$.ajax({
  				url:"/api/matches/"+match_id,
  				method:"DELETE",
  				success:function(){
	  				loadMatches();
	  			}
  			});
  		});


      $("#players").on("click",".user",function(){
        cc = $(this).data("clicks");
        if(cc==4){
          cc=0;
        }
        else {
          cc+=1;
        }
        $(this).data("clicks",cc);
        if (cc == 0){
          $(this).removeClass("uno due tre quattro");
        }else if (cc == 1){
          $(this).addClass("uno");
        }else if (cc == 2){
          $(this).addClass("due");
        }else if (cc == 3){
          $(this).addClass("tre");
        }else if (cc == 4){
          $(this).addClass("quattro");
        }
      });

  	});
  </script>
  <body>
    <div id="details">
      <div id="pool">Bestia: <strong></strong></div>
      <div id="players"></div>
      <a href="#" id="conta">Conta</a>
    </div>
  	<div id="matches"></div>
  	<div id="users"></div>
  	<div id="new">
	  	<form id="new-user" action="/api/users" method="post">
	  		<input id="name" type="text" name="name" placeholder="Name for new player"/>
	  	</form>
  	</div>
  	
  </body>	
</html>